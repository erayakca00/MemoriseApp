@page "/words/add"
@rendermode InteractiveServer 
@using MemoriseApp.Data @*// ApplicationDbContext için *@
@using MemoriseApp.Models @*// Word, WordSample için (eğer Models klasöründeyse)  *@
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager

<h3>Yeni Kelime Ekle</h3>

<EditForm Model="@newWord" OnValidSubmit="@HandleValidSubmit" FormName="AddWordForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="engWord" class="form-label">İngilizce Kelime:</label>
        <InputText id="engWord" class="form-control" @bind-Value="newWord.EngWordName" />
        <ValidationMessage For="@(() => newWord.EngWordName)" />
    </div>

    <div class="mb-3">
        <label for="turWord" class="form-label">Türkçe Karşılığı:</label>
        <InputText id="turWord" class="form-control" @bind-Value="newWord.TurWordName" />
        <ValidationMessage For="@(() => newWord.TurWordName)" />
    </div>

    <div class="mb-3">
        <label for="sampleSentence" class="form-label">Örnek Cümle:</label>
        <InputText id="sampleSentence" class="form-control" @bind-Value="sampleSentence" />
    </div>

    <button type="submit" class="btn btn-primary">Kaydet</button>
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success mt-3">@successMessage</div>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
</EditForm>






@code {

    // Form ile bağlanacak yeni word nesnesi
    private Word newWord = new Word();

    //Örnek cümleyi geçici olarak tutacak değişken
    private string sampleSentence = string.Empty;

    // Başarılı veya hatalı mesajları için
    private string? successMessage;
    private string? errorMessage;

    private async Task HandleValidSubmit()
    {


        // --- DEBUG LOGGING BAŞLANGIÇ (burası kaldırılacak)---
        Console.WriteLine("--- HandleValidSubmit Başladı (Dolu Veri Testi) ---");
        Console.WriteLine($"Formdan Gelen EngWordName: '{newWord.EngWordName}'");
        Console.WriteLine($"Formdan Gelen TurWordName: '{newWord.TurWordName}'");
        Console.WriteLine($"Formdan Gelen SampleSentence: '{sampleSentence}'");
        Console.WriteLine("--------------------------------------------------");
        // --- DEBUG LOGGING BİTİŞ ---
        successMessage = null;
        errorMessage = null;

        // Girilen İngilizce veya Türkçe kelimenin veritabanında (büyük/küçük harf duyarsız) olup olmadığını kontrol et
        string lowerEngWord = newWord.EngWordName.ToLower();
        string lowerTurWord = newWord.TurWordName.ToLower(); // Türkçe kelimeyi de küçük harfe çevir

        // Hem İngilizce hem de Türkçe kelime için kontrol yap
        bool duplicateExists = await DbContext.Words
                                              .AnyAsync(w => w.EngWordName.ToLower() == lowerEngWord || // İngilizce eşleşiyor VEYA
                                                             w.TurWordName.ToLower() == lowerTurWord);   // Türkçe eşleşiyor

        if (duplicateExists)
        {
            
            // Hangi kelimenin çakıştığını bulmak için ek sorgu yapılabilir (daha karmaşık)
            var existing = await DbContext.Words.FirstOrDefaultAsync(w => w.EngWordName.ToLower() == lowerEngWord || w.TurWordName.ToLower() == lowerTurWord);
            if (existing != null) {
                if (existing.EngWordName.Equals(newWord.EngWordName, StringComparison.OrdinalIgnoreCase))
                    errorMessage = $"İngilizce kelime '{newWord.EngWordName}' zaten mevcut.";
                else
                    errorMessage = $"Türkçe kelime '{newWord.TurWordName}' zaten mevcut (İngilizce karşılığı: '{existing.EngWordName}').";
            }

            StateHasChanged(); // Hata mesajını göster
            return; // Metoddan çık, kaydetme işlemi yapma
        }

        try
        {
            WordSample? wordSampleToAdd = null;
            if (!string.IsNullOrWhiteSpace(sampleSentence))
            {
                wordSampleToAdd = new WordSample
                    {
                        SampleSentence = sampleSentence,
                        Word = newWord
                    };
            }

            // Yeni kelimeyi veritabanına ekle
            DbContext.Words.Add(newWord);
            await DbContext.SaveChangesAsync();

            successMessage = $"'{newWord.EngWordName}' kelimesi başarıyla eklendi!";

            newWord = new Word(); // Formu sıfırla
            sampleSentence = string.Empty; // Örnek cümleyi sıfırla

            StateHasChanged(); // UI'yi güncelle
        }

        catch (DbUpdateException dbEx)
        {
            errorMessage = $"Veritabanı hatası: {dbEx.InnerException?.Message ?? dbEx.Message}";
            Console.WriteLine($"Hata Detayı: {dbEx.ToString()}");
            StateHasChanged();  
        }

        catch (Exception ex)
        {
            errorMessage = $"Kelime eklenirken bir hata oluştu: {ex.Message}"; 
        }
    }
}
